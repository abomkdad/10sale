<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no"/>
  <title>MAD Perfumeur â€“ Landing</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body{background:#0b0f19;color:#fff}
    .no-scrollbar::-webkit-scrollbar{display:none}
    .no-scrollbar{-ms-overflow-style:none;scrollbar-width:none}
    .full-bleed{width:100vw;max-width:100vw;margin-left:calc(50% - 50vw);margin-right:calc(50% - 50vw)}
    img{-webkit-user-drag:none;user-select:none;display:block}
    .card-selected{border-color:rgb(245 158 11)!important; box-shadow:0 0 0 2px rgb(245 158 11 / 0.35)}
    .check-badge{position:absolute; top:.4rem; inset-inline-end:.4rem; background:rgb(245 158 11); color:#111827; font-weight:700; font-size:.7rem; padding:.15rem .4rem; border-radius:.5rem}
  </style>
</head>
<body class="min-h-screen overflow-x-hidden">
  <div id="app" class="mx-auto w-full max-w-sm px-3 pb-28">

    <!-- HEADER -->
    <header class="sticky top-0 z-30 backdrop-blur bg-[#0e1424]/80 border-b border-slate-800">
      <div class="flex items-center gap-3 p-3">
        <img src="img/logo.png" onerror="this.style.display='none'" alt="logo" class="h-8 w-8 rounded-full ring-2 ring-amber-500">
        <div class="flex-1 leading-tight">
          <h1 id="t_title" class="text-sm font-semibold">...</h1>
          <p class="text-[11px] text-slate-400">MAD Perfumeur</p>
        </div>
        <a id="callWa" href="#" class="text-amber-400 text-sm">WhatsApp</a>
      </div>
    </header>

    <!-- HERO -->
    <section class="mt-3">
      <div class="rounded-2xl overflow-hidden border border-slate-800 bg-slate-900">
        <img id="heroImg" src="img/p1.png" alt="Ø§Ù„Ù…Ù†ØªØ¬ Ø§Ù„Ù…Ø®ØªØ§Ø±" class="w-full h-auto">
      </div>
      <div id="selectedPill" class="mt-2 hidden text-[12px] text-emerald-300">âœ“ ØªÙ… Ø§Ø®ØªÙŠØ§Ø± Ù‡Ø°Ø§ Ø§Ù„Ù…Ù†ØªØ¬</div>
    </section>

    <!-- CAROUSEL -->
    <section class="mt-3">
      <div id="carousel" class="flex gap-3 overflow-x-auto snap-x snap-mandatory no-scrollbar px-1 pb-1"></div>
      <p id="t_choose" class="text-center text-[12px] text-slate-400 mt-1">Ø§Ø®ØªØ± Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø©</p>
    </section>

    <!-- ORDER -->
    <section class="mt-2">
      <div class="rounded-2xl border border-slate-800 bg-slate-900/60">
        <form id="orderForm" class="p-3 space-y-3">
          <div>
            <label id="t_name" class="text-[11px] text-slate-400">Ø§Ù„Ø§Ø³Ù… Ø§Ù„ÙƒØ§Ù…Ù„</label>
            <input id="name" required class="mt-1 w-full rounded-xl bg-slate-800 border border-slate-700 p-2 text-sm"/>
          </div>
          <div>
            <label id="t_phone" class="text-[11px] text-slate-400">Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ</label>
            <input id="phone" required class="mt-1 w-full rounded-xl bg-slate-800 border border-slate-700 p-2 text-sm"/>
          </div>
          <div>
            <label id="t_city" class="text-[11px] text-slate-400">Ø§Ù„Ù…Ø¯ÙŠÙ†Ø© / Ø§Ù„Ø¹Ù†ÙˆØ§Ù†</label>
            <input id="city" required class="mt-1 w-full rounded-xl bg-slate-800 border border-slate-700 p-2 text-sm"/>
          </div>
          <div>
            <label id="t_notes" class="text-[11px] text-slate-400">Ù…Ù„Ø§Ø­Ø¸Ø§Øª (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)</label>
            <textarea id="notes" rows="2" class="mt-1 w-full rounded-xl bg-slate-800 border border-slate-700 p-2 text-sm"></textarea>
          </div>

          <div class="flex items-start gap-2 text-xs text-slate-300">
            <input id="agree" type="checkbox" class="mt-1">
            <label id="t_confirm" for="agree" class="leading-snug">Ø£Ø¤ÙƒØ¯ Ø£Ù† Ù‡Ø°Ø§ Ø§Ù„Ù†Ù…ÙˆØ°Ø¬ Ø®Ø§Øµ Ø¨Ø§Ù„Ø·Ù„Ø¨ ÙÙ‚Ø· ÙˆÙ„ÙŠØ³ Ù„Ù„Ø§Ø³ØªÙØ³Ø§Ø±Ø§ØªØŒ ÙˆØ£ÙˆØ§ÙÙ‚ Ø¹Ù„Ù‰ Ø¥ØªÙ…Ø§Ù… Ø§Ù„Ø·Ù„Ø¨ ÙˆÙÙ‚ Ø§Ù„ØªÙØ§ØµÙŠÙ„.</label>
          </div>

          <div class="flex gap-2">
            <button id="sendBtn" type="submit" class="flex-1 inline-flex items-center justify-center gap-2 rounded-2xl py-3 text-sm font-semibold bg-amber-500 text-slate-900 hover:bg-amber-400 disabled:opacity-60 disabled:cursor-not-allowed">
              <span id="t_send">Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø·Ù„Ø¨ Ø¹Ø¨Ø± ÙˆØ§ØªØ³Ø§Ø¨</span>
            </button>
            <button id="previewBtn" type="button" class="px-3 rounded-2xl border border-slate-700 bg-slate-800 text-sm">
              <span id="t_preview">Ù…Ø¹Ø§ÙŠÙ†Ø©</span>
            </button>
          </div>
        </form>
      </div>
    </section>

    <!-- ABOUT -->
    <section class="mt-4">
      <img id="aboutImg" src="" alt="About / ×¢×œ ×”×—×‘×¨×”" class="full-bleed block h-auto" loading="lazy" decoding="async">
      <p id="aboutStatus" class="text-center text-[12px] text-red-300 mt-1"></p>
    </section>

    <!-- STICKY CTA -->
    <div class="fixed bottom-2 inset-x-3 z-30">
      <a href="#" id="ctaTop" class="block w-full text-center rounded-2xl py-3 bg-gradient-to-r from-amber-400 to-amber-500 text-slate-900 font-bold shadow-lg">
        <span id="t_orderNow">Ø§Ø·Ù„Ø¨ Ø§Ù„Ø¢Ù†</span>
      </a>
    </div>
  </div>

  <!-- PREVIEW MODAL -->
  <div id="modal" class="hidden fixed inset-0 z-50 bg-black/70 items-center justify-center p-3">
    <div class="w-full max-w-sm rounded-2xl bg-slate-900 border border-slate-800 overflow-hidden">
      <div class="flex items-center justify-between p-3 border-b border-slate-800">
        <p id="t_previewTitle" class="text-sm font-semibold">Ù…Ø¹Ø§ÙŠÙ†Ø©</p>
        <button id="closeModal" class="p-1 rounded-lg bg-slate-800 border border-slate-700">âœ•</button>
      </div>
      <div class="p-3 space-y-3">
        <div class="rounded-2xl overflow-hidden border border-slate-800">
          <img id="prevImg" src="img/p1.png" class="w-full h-auto">
        </div>
        <div class="text-xs text-slate-200 space-y-1">
          <div><b id="t_prevName">Ø§Ù„Ø§Ø³Ù…:</b> <span id="prevName">â€”</span></div>
          <div><b id="t_prevPhone">Ø§Ù„Ù‡Ø§ØªÙ:</b> <span id="prevPhone">â€”</span></div>
          <div><b id="t_prevAddr">Ø§Ù„Ø¹Ù†ÙˆØ§Ù†:</b> <span id="prevAddr">â€”</span></div>
          <div id="prevNotesWrap" class="hidden"><b id="t_prevNotes">Ù…Ù„Ø§Ø­Ø¸Ø§Øª:</b> <span id="prevNotes">â€”</span></div>
        </div>
        <div class="flex gap-2">
          <button id="sendFromPreview" class="flex-1 inline-flex items-center justify-center gap-2 rounded-xl bg-amber-500 text-slate-900 py-2 text-sm font-semibold">
            <span id="t_sendNow">Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø·Ù„Ø¨ Ø§Ù„Ø¢Ù†</span>
          </button>
          <a id="downloadPromo" class="hidden flex-1 inline-flex items-center justify-center gap-2 rounded-xl bg-slate-800 border border-slate-700 py-2 text-sm">
            <span id="t_download">ØªÙ†Ø²ÙŠÙ„ Ø§Ù„ØµÙˆØ±Ø©</span>
          </a>
        </div>
      </div>
    </div>
  </div>

<script>
/*** CONFIG ***/
let WHATSAPP_NUMBER = "972506164130"; // ØºÙŠÙ‘Ø±Ù‡ Ù…Ù† ?wa= Ù„Ùˆ Ù„Ø²Ù…
const PRODUCTS = [
  { id:"Q106", name:"Ø¨Ø§Ù‚Ø© 3 Ø¹Ø·ÙˆØ± â€“ ÙƒÙ„Ø§Ø³ÙŠÙƒ", img:"img/p1.png" },
  { id:"Q110", name:"Ø¨Ø§Ù‚Ø© 5 Ø¹Ø·ÙˆØ± â€“ Ø¬ÙˆÙ„Ø¯",   img:"img/p2.png" },
  { id:"T109", name:"Ombre Style",          img:"img/p3.png" },
  { id:"A118", name:"Aventus Style",        img:"img/p4.png" },
  { id:"C120", name:"Coco Style",           img:"img/p5.png" },
  { id:"R130", name:"Rose Oud",             img:"img/p6.png" },
  { id:"N101", name:"Neroli",               img:"img/p7.png" },
  { id:"S205", name:"Santal",               img:"img/p8.png" },
  { id:"M501", name:"Musk",                 img:"img/p9.png" },
  { id:"H777", name:"Hair Mist Set",        img:"img/p10.png"}
];

/*** I18N ***/
const STR = {
  ar: { title:"Ø¹Ø·ÙˆØ± Ù…Ø®ØªØ§Ø±Ø© â€“ Ø§Ø·Ù„Ø¨ Ø§Ù„Ø¢Ù† Ø¹Ø¨Ø± ÙˆØ§ØªØ³Ø§Ø¨", choose:"Ø§Ø®ØªØ± Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø©", selected:"âœ“ ØªÙ… Ø§Ø®ØªÙŠØ§Ø± Ù‡Ø°Ø§ Ø§Ù„Ù…Ù†ØªØ¬",
        name:"Ø§Ù„Ø§Ø³Ù… Ø§Ù„ÙƒØ§Ù…Ù„", phone:"Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ", city:"Ø§Ù„Ù…Ø¯ÙŠÙ†Ø© / Ø§Ù„Ø¹Ù†ÙˆØ§Ù†", notes:"Ù…Ù„Ø§Ø­Ø¸Ø§Øª (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)",
        confirm:"Ø£Ø¤ÙƒØ¯ Ø£Ù† Ù‡Ø°Ø§ Ø§Ù„Ù†Ù…ÙˆØ°Ø¬ Ø®Ø§Øµ Ø¨Ø§Ù„Ø·Ù„Ø¨ ÙÙ‚Ø· ÙˆÙ„ÙŠØ³ Ù„Ù„Ø§Ø³ØªÙØ³Ø§Ø±Ø§ØªØŒ ÙˆØ£ÙˆØ§ÙÙ‚ Ø¹Ù„Ù‰ Ø¥ØªÙ…Ø§Ù… Ø§Ù„Ø·Ù„Ø¨ ÙˆÙÙ‚ Ø§Ù„ØªÙØ§ØµÙŠÙ„.",
        send:"Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø·Ù„Ø¨ Ø¹Ø¨Ø± ÙˆØ§ØªØ³Ø§Ø¨", preview:"Ù…Ø¹Ø§ÙŠÙ†Ø©", orderNow:"Ø§Ø·Ù„Ø¨ Ø§Ù„Ø¢Ù†", previewTitle:"Ù…Ø¹Ø§ÙŠÙ†Ø©",
        prevName:"Ø§Ù„Ø§Ø³Ù…:", prevPhone:"Ø§Ù„Ù‡Ø§ØªÙ:", prevAddr:"Ø§Ù„Ø¹Ù†ÙˆØ§Ù†:", prevNotes:"Ù…Ù„Ø§Ø­Ø¸Ø§Øª:",
        sendNow:"Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø·Ù„Ø¨ Ø§Ù„Ø¢Ù†", download:"ØªÙ†Ø²ÙŠÙ„ Ø§Ù„ØµÙˆØ±Ø©" },
  he: { title:"×‘×©××™× × ×‘×—×¨×™× â€“ ×”×–×× ×” ×‘×•×•×˜×¡××¤", choose:"×‘×—×¨×• ×§×‘×•×¦×”", selected:"âœ“ ×”××•×¦×¨ × ×‘×—×¨",
        name:"×©× ××œ×", phone:"××¡×¤×¨ ×˜×œ×¤×•×Ÿ", city:"×¢×™×¨ / ×›×ª×•×‘×ª", notes:"×”×¢×¨×•×ª (××•×¤×¦×™×•× ×œ×™)",
        confirm:"×× ×™ ×××©×¨/×ª ×©×˜×•×¤×¡ ×–×” ××™×•×¢×“ ×œ×”×–×× ×” ×‘×œ×‘×“ ×•×œ× ×œ×¤× ×™×•×ª ×›×œ×œ×™×•×ª, ×•××¡×›×™×/×” ×œ×”×©×œ×™× ××ª ×”×”×–×× ×” ×œ×¤×™ ×”×¤×¨×˜×™×.",
        send:"×©×œ×™×—×ª ×”×”×–×× ×” ×‘×•×•×˜×¡××¤", preview:"×ª×¦×•×’×” ××§×“×™××”", orderNow:"×”×–×× ×” ×¢×›×©×™×•", previewTitle:"×ª×¦×•×’×” ××§×“×™××”",
        prevName:"×©×:", prevPhone:"×˜×œ×¤×•×Ÿ:", prevAddr:"×›×ª×•×‘×ª:", prevNotes:"×”×¢×¨×•×ª:",
        sendNow:"×©×œ×—/×™ ×”×–×× ×” ×¢×›×©×™×•", download:"×”×•×¨×“/×™ ×ª××•× ×”" }
};
function detectLang(){
  const qs=new URLSearchParams(location.search);
  const q=qs.get('lang');
  if(q==='ar'||q==='he') return q;
  const nav=(navigator.languages&&navigator.languages[0])||navigator.language||'ar';
  if(/^he\b/i.test(nav)) return 'he';
  if(/^ar\b/i.test(nav)) return 'ar';
  return 'ar';
}
let LANG = detectLang();

/*** Helpers ***/
const els = {
  callWa:document.getElementById('callWa'),
  hero:document.getElementById('heroImg'),
  selectedPill:document.getElementById('selectedPill'),
  carousel:document.getElementById('carousel'),
  name:document.getElementById('name'),
  phone:document.getElementById('phone'),
  city:document.getElementById('city'),
  notes:document.getElementById('notes'),
  agree:document.getElementById('agree'),
  form:document.getElementById('orderForm'),
  previewBtn:document.getElementById('previewBtn'),
  ctaTop:document.getElementById('ctaTop'),
  modal:document.getElementById('modal'),
  closeModal:document.getElementById('closeModal'),
  prevImg:document.getElementById('prevImg'),
  prevName:document.getElementById('prevName'),
  prevPhone:document.getElementById('prevPhone'),
  prevAddr:document.getElementById('prevAddr'),
  prevNotesWrap:document.getElementById('prevNotesWrap'),
  prevNotes:document.getElementById('prevNotes'),
  sendFromPreview:document.getElementById('sendFromPreview'),
  downloadPromo:document.getElementById('downloadPromo'),
  // labels
  t:{
    title:document.getElementById('t_title'), choose:document.getElementById('t_choose'),
    orderNow:document.getElementById('t_orderNow'), previewTitle:document.getElementById('t_previewTitle'),
    name:document.getElementById('t_name'), phone:document.getElementById('t_phone'),
    city:document.getElementById('t_city'), notes:document.getElementById('t_notes'),
    confirm:document.getElementById('t_confirm'), send:document.getElementById('t_send'),
    preview:document.getElementById('t_preview'), prevName:document.getElementById('t_prevName'),
    prevPhone:document.getElementById('t_prevPhone'), prevAddr:document.getElementById('t_prevAddr'),
    prevNotes:document.getElementById('t_prevNotes'), sendNow:document.getElementById('t_sendNow'),
    download:document.getElementById('t_download')
  }
};

function i18n(){
  const S=STR[LANG] || STR.ar;
  document.documentElement.lang = LANG==='he'?'he':'ar';
  document.documentElement.dir  = 'rtl';
  els.t.title.textContent=S.title; els.t.choose.textContent=S.choose; els.t.orderNow.textContent=S.orderNow;
  els.t.previewTitle.textContent=S.previewTitle; els.t.name.textContent=S.name; els.t.phone.textContent=S.phone;
  els.t.city.textContent=S.city; els.t.notes.textContent=S.notes; els.t.confirm.textContent=S.confirm;
  els.t.send.textContent=S.send; els.t.preview.textContent=S.preview;
  els.t.prevName.textContent=S.prevName; els.t.prevPhone.textContent=S.prevPhone; els.t.prevAddr.textContent=S.prevAddr;
  els.t.prevNotes.textContent=S.prevNotes; els.t.sendNow.textContent=S.sendNow; els.t.download.textContent=S.download;
  if (els.selectedPill) els.selectedPill.textContent = S.selected;
}

function normalizeILPhone(input){
  const d=(input||"").replace(/\D+/g,"");
  if(!d) return "";
  if(d.startsWith("972")){
    const local=d.slice(3);
    return local.startsWith("0")?local:"0"+local;
  }
  if(d.startsWith("05")) return d;
  if(d.startsWith("5")) return "0"+d;
  return d;
}

/*** Ù†Øµ ÙˆØ§ØªØ³Ø§Ø¨ ***/
function buildText({name,phone,city,notes}){
  const S=(STR[LANG]||STR.ar);
  return (
   `ğŸ§¾ MAD Perfumeur â€” ${LANG==='he'?'×”×–×× ×” ×—×“×©×”':'Ø·Ù„Ø¨ Ø¬Ø¯ÙŠØ¯'}\n\n`+
   `${S.prevName} ${name}\n`+
   `${S.prevPhone} ${phone}\n`+
   `${S.prevAddr} ${city}\n`+
   (notes?`${S.prevNotes} ${notes}\n\n`:"\n")+
   `${LANG==='he'?'×× ×™ ×××©×¨/×ª ×‘×™×¦×•×¢ ×”×–×× ×” ×œ×¤×™ ×”×¤×¨×˜×™×.':'Ø£Ø¤ÙƒØ¯ ØªÙ†ÙÙŠØ° Ø§Ù„Ø·Ù„Ø¨ ÙˆÙÙ‚ Ø§Ù„ØªÙØ§ØµÙŠÙ„.'}`
  );
}

/*** ÙƒÙØ§Ù†ÙØ³: Ø¥Ù†Ø´Ø§Ø¡ ØµÙˆØ±Ø© ÙØ§ØªÙˆØ±Ø© Ù…Ø¯Ù…Ø¬Ø© (Ø§Ù„Ù…Ù†ØªØ¬ + Ø§Ù„ØªÙØ§ØµÙŠÙ„ + Ø¨Ø§Ø±ÙƒÙˆØ¯ + Ù„ÙˆØ¬Ùˆ) ***/
async function makeInvoiceImage(productUrl, data){
  // Ø¥Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ù‚Ù…Ø§Ø´
  const W = 1080, P = 48; // Ø¹Ø±Ø¶ Ø«Ø§Ø¨Øª 1080px
  const canvas = document.createElement('canvas'); const ctx = canvas.getContext('2d');
  // Ø­Ù…Ù‘Ù„ ØµÙˆØ±Ø© Ø§Ù„Ù…Ù†ØªØ¬
  const img = await loadImage(productUrl);
  // Ø§Ø±ØªÙØ§Ø¹ Ø¯ÙŠÙ†Ø§Ù…ÙŠÙƒÙŠ: ØµÙˆØ±Ø© Ø§Ù„Ù…Ù†ØªØ¬ + Ø¨Ù„ÙˆÙƒ Ø§Ù„ØªÙØ§ØµÙŠÙ„
  const prodH = Math.round(W * (img.height / img.width));
  const detailsH = 520;
  canvas.width = W; canvas.height = prodH + detailsH;

  // Ø®Ù„ÙÙŠØ©
  ctx.fillStyle = '#0b0f19'; ctx.fillRect(0,0,canvas.width,canvas.height);

  // ØµÙˆØ±Ø© Ø§Ù„Ù…Ù†ØªØ¬
  ctx.drawImage(img, 0, 0, W, prodH);

  // Ù„ÙˆØ¬Ùˆ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)
  try{
    const logo = await loadImage('img/logo.png');
    const sz = 120;
    ctx.drawImage(logo, P, prodH + P, sz, sz);
  }catch{}

  // Ù†ØµÙˆØµ
  ctx.fillStyle = '#ffffff';
  ctx.font = '700 44px system-ui, -apple-system, Segoe UI, Arial';
  ctx.fillText('MAD Perfumeur', P+140, prodH + P + 64);

  ctx.font = '600 40px system-ui, -apple-system, Segoe UI, Arial';
  ctx.fillStyle = '#f59e0b';
  ctx.fillText(LANG==='he'?'××™×©×•×¨ ×”×–×× ×”':'ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø·Ù„Ø¨', P, prodH + 180);

  ctx.fillStyle = '#d1d5db';
  ctx.font = '400 36px system-ui, -apple-system, Segoe UI, Arial';
  const L = (STR[LANG]||STR.ar);
  const lines = [
    `${L.prevName} ${data.name}`,
    `${L.prevPhone} ${data.phone}`,
    `${L.prevAddr} ${data.city}`,
    data.notes ? `${L.prevNotes} ${data.notes}` : null
  ].filter(Boolean);

  lines.forEach((t,i)=>{ ctx.fillText(t, P, prodH + 240 + i*54); });

  // Ø¨Ø§Ø±ÙƒÙˆØ¯ Ø¨Ø³ÙŠØ· (ÙˆÙ‡Ù…ÙŠ)
  const bx = W - P - 380, by = prodH + 60, bw = 340, bh = 140;
  ctx.fillStyle = '#111827'; roundRect(ctx, bx-20, by-20, bw+40, bh+40, 16); ctx.fill();
  drawFakeBarcode(ctx, bx, by, bw, bh);

  // Ø®ØªÙ… ØªØ£ÙƒÙŠØ¯
  ctx.save();
  ctx.translate(W - 220, prodH + 360);
  ctx.rotate(-0.1);
  ctx.strokeStyle = '#f59e0b'; ctx.lineWidth = 6; ctx.fillStyle = 'rgba(245,158,11,0.15)';
  roundRect(ctx, -160, -48, 320, 96, 18); ctx.fill(); ctx.stroke();
  ctx.fillStyle = '#f59e0b'; ctx.font='700 40px system-ui, -apple-system, Segoe UI, Arial';
  ctx.textAlign='center'; ctx.fillText(LANG==='he'?'××•×©×¨':'ØªÙ… Ø§Ù„ØªØ£ÙƒÙŠØ¯', 0, 14);
  ctx.restore();

  // Ù…Ù„Ù
  const blob = await new Promise(res=>canvas.toBlob(res, 'image/png', 0.95));
  return new File([blob], 'mad-order.png', {type:'image/png'});

  function loadImage(url){
    return new Promise((res,rej)=>{ const im=new Image(); im.crossOrigin='anonymous'; im.onload=()=>res(im); im.onerror=rej; im.src=url; });
  }
  function roundRect(ctx,x,y,w,h,r){ const rr=Math.min(r,w/2,h/2); ctx.beginPath();
    ctx.moveTo(x+rr,y); ctx.arcTo(x+w,y,x+w,y+h,rr); ctx.arcTo(x+w,y+h,x,y+h,rr); ctx.arcTo(x,y+h,x,y,rr); ctx.arcTo(x,y,x+w,y,rr); ctx.closePath(); }
  function drawFakeBarcode(ctx,x,y,w,h){
    ctx.fillStyle='#e5e7eb'; ctx.fillRect(x,y,w,h);
    ctx.fillStyle='#111827';
    let cur=x+10; while(cur<x+w-10){ const barW = Math.floor(2+Math.random()*6); const gap = Math.floor(2+Math.random()*6);
      ctx.fillRect(cur,y+8,barW,h-16); cur+=barW+gap;
    }
    // Ø£Ø±Ù‚Ø§Ù… ØªØ­Øª
    ctx.fillStyle='#111827'; ctx.font='600 24px system-ui, -apple-system, Segoe UI, Arial';
    ctx.textAlign='center'; ctx.fillText('MAD'+Math.floor(100000+Math.random()*899999), x+w/2, y+h+28);
    ctx.textAlign='start';
  }
}

/*** Ø§Ù„Ù…Ø´Ø§Ø±ÙƒØ© / Ø§Ù„Ø¥Ø±Ø³Ø§Ù„ ***/
function openWhatsAppTextOnly(text){
  const urlApp = `whatsapp://send?phone=${WHATSAPP_NUMBER}&text=${encodeURIComponent(text)}`;
  const urlWeb = `https://wa.me/${WHATSAPP_NUMBER}?text=${encodeURIComponent(text)}`;
  try { window.location.href = urlApp; setTimeout(()=>window.open(urlWeb,"_blank"), 700); }
  catch { window.open(urlWeb,"_blank"); }
}

/*** Render + Carousel + Select ***/
let selectedIndex = 0;
let selected = PRODUCTS[0];

function renderSelected(){
  els.hero.src = selected.img;
  // Ø¥Ø¨Ø±Ø§Ø²
  [...els.carousel.querySelectorAll('.card')].forEach(c=>{
    c.classList.remove('card-selected');
    const b=c.querySelector('.check-badge'); if(b) b.remove();
  });
  const card = els.carousel.querySelector(`[data-idx="${selectedIndex}"]`);
  if(card){
    card.classList.add('card-selected');
    const badge = document.createElement('div'); badge.className='check-badge'; badge.textContent='âœ“';
    (card.querySelector('.imgwrap')||card).appendChild(badge);
  }
  els.selectedPill?.classList.remove('hidden');
}

function renderCarousel(){
  els.carousel.innerHTML="";
  PRODUCTS.forEach((p,idx)=>{
    const btn=document.createElement('button');
    btn.className="card snap-start shrink-0 w-40 rounded-2xl p-2 bg-slate-900 border transition border-slate-800";
    btn.setAttribute('data-idx', idx);
    btn.innerHTML = `
      <div class="imgwrap relative overflow-hidden rounded-xl bg-slate-800">
        <img src="${p.img}" alt="" class="w-full h-auto">
      </div>
    `;
    btn.addEventListener('click', ()=>{
      selectedIndex = idx; selected = p; renderSelected();
      document.getElementById('app').scrollTo({top:0,behavior:'smooth'});
    });
    els.carousel.appendChild(btn);
  });
}

/*** AUTO CAROUSEL ***/
let autoTimer=null, autoIdx=0, autoResume=null;
function startAutoCarousel(){
  stopAutoCarousel();
  const cont = els.carousel; if(!cont) return;
  const items = [...cont.children]; if(items.length<=2) return;
  autoIdx = 0;
  autoTimer = setInterval(()=>{
    autoIdx = (autoIdx + 1) % items.length;
    const target = items[autoIdx];
    cont.scrollTo({ left: target.offsetLeft - 8, behavior:'smooth' });
  }, 1000);
}
function stopAutoCarousel(){ if(autoTimer){ clearInterval(autoTimer); autoTimer=null; } }
function pauseAuto(){ stopAutoCarousel(); clearTimeout(autoResume); autoResume=setTimeout(startAutoCarousel, 5000); }
['pointerdown','wheel','touchstart','mouseenter'].forEach(ev=>{
  els.carousel?.addEventListener(ev, pauseAuto, {passive:true});
});
document.addEventListener('visibilitychange', ()=>{ if(document.hidden) stopAutoCarousel(); else pauseAuto(); });

/*** Preview + Send ***/
function fillPreview(){
  els.prevImg.src = selected.img;
  const norm = normalizeILPhone(els.phone.value);
  prevName.textContent  = els.name.value || 'â€”';
  prevPhone.textContent = norm || 'â€”';
  prevAddr.textContent  = els.city.value || 'â€”';
  const n=(els.notes.value||"").trim();
  if(n){ prevNotesWrap.classList.remove('hidden'); prevNotes.textContent=n; }
  else { prevNotesWrap.classList.add('hidden'); prevNotes.textContent=""; }
}

async function doSend(){
  if(!els.agree.checked){
    alert(LANG==='he'?'×™×© ×œ××©×¨ ××ª ×”×ª× ××™× ×œ×¤× ×™ ×©×œ×™×—×”':'ÙŠØ±Ø¬Ù‰ ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ù…ÙˆØ§ÙÙ‚Ø© Ø¹Ù„Ù‰ Ø§Ù„Ø´Ø±ÙˆØ· Ù‚Ø¨Ù„ Ø§Ù„Ø¥Ø±Ø³Ø§Ù„.');
    return;
  }
  const data = {
    name: els.name.value.trim(),
    phone: normalizeILPhone(els.phone.value),
    city:  els.city.value.trim(),
    notes: (els.notes.value||"").trim()
  };
  const text = buildText(data);

  // 1) Ø¬Ø±Ù‘Ø¨ Ù…Ø´Ø§Ø±ÙƒØ© Ø§Ù„ØµÙˆØ±Ø© + Ø§Ù„Ù†Øµ Ø¹Ø¨Ø± Web Share (Ø£ÙØ¶Ù„ ØªØ¬Ø±Ø¨Ø©)
  try{
    const file = await makeInvoiceImage(selected.img, data);
    const shareData = { files:[file], text, title:'MAD Order' };
    if(navigator.canShare && navigator.canShare(shareData)){
      await navigator.share(shareData);
      return;
    }
  }catch(e){ /* ØªØ¬Ø§Ù‡Ù„ */ }

  // 2) Ø¥Ù† Ù„Ù… ÙŠÙØ¯Ø¹ÙÙ…: Ù†Ø²Ù‘Ù„ Ø§Ù„ØµÙˆØ±Ø© ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹ ÙˆØ§ÙØªØ­ Ù…Ø­Ø§Ø¯Ø«Ø© Ø§Ù„Ø±Ù‚Ù… Ø¨Ø§Ù„Ù†Øµ Ø§Ù„Ø¬Ø§Ù‡Ø²
  try{
    const file = await makeInvoiceImage(selected.img, data);
    const a=document.createElement('a'); a.href=URL.createObjectURL(file); a.download='mad-order.png';
    document.body.appendChild(a); a.click(); a.remove();
  }catch(e){}
  openWhatsAppTextOnly(text);

  // 3) Ø£Ø¸Ù‡Ø± Ø§Ù„Ù…Ø¹Ø§ÙŠÙ†Ø© Ø£ÙŠØ¶Ø§Ù‹
  fillPreview();
  els.downloadPromo.classList.remove('hidden');
  els.downloadPromo.href = selected.img;
  modal.classList.remove('hidden'); modal.classList.add('flex');
}

/*** About BNG auto-detect ***/
function canLoad(src){
  return new Promise(res=>{
    const im=new Image();
    im.onload=()=>res(true);
    im.onerror=()=>res(false);
    im.src = src + (src.includes('?')?'&':'?') + 'v=' + Date.now();
  });
}
async function setAboutAuto(){
  const el = document.getElementById('aboutImg');
  const statusEl = document.getElementById('aboutStatus');

  const qs = new URLSearchParams(location.search);
  const aboutQS = qs.get('about');
  if (aboutQS) {
    const direct = 'img/' + decodeURIComponent(aboutQS);
    if (await canLoad(direct)) { el.src = direct; statusEl && (statusEl.textContent = ''); return; }
  }
  const prim = ['img/About%20BNG.png','img/About%20BNG.jpg','img/About%20BNG.webp'];
  for (const p of prim) if(await canLoad(p)){ el.src=p; statusEl.textContent=''; return; }

  const bases=['About BNG','ABOUT BNG','about bng','About_BNG','ABOUT_BNG','about_bng','About-BNG','ABOUT-BNG','about-bng'];
  const suffix=['',' (1)',' (2)',' (3)',' (final)','_final','-final'];
  const exts=['.png','.jpg','.jpeg','.webp','.gif','.PNG','.JPG','.JPEG','.WEBP','.GIF'];
  const encs=s=>[s,s.replace(/\s/g,'%20'),s.replace(/\s/g,'+')];
  for(const b of bases) for(const s of suffix) for(const e of exts)
    for(const p of encs(`img/${b}${s}${e}`))
      if(await canLoad(p)){ el.src=p; statusEl.textContent=''; return; }

  for(const f of ['about','About','ABOUT']) for(const e of exts){
    const p=`img/${f}${e}`; if(await canLoad(p)){ el.src=p; statusEl.textContent=''; return; }
  }
  statusEl.textContent = LANG==='he' ? '×œ× × ××¦××” ×ª××•× ×ª About BNG ×‘×ª×™×§×™×™×ª img' : 'Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ ØµÙˆØ±Ø© About BNG Ø¯Ø§Ø®Ù„ Ù…Ø¬Ù„Ø¯ img';
}

/*** Events ***/
document.getElementById('previewBtn').onclick = ()=>{ fillPreview(); modal.classList.remove('hidden'); modal.classList.add('flex'); };
document.getElementById('closeModal').onclick = ()=>{ modal.classList.add('hidden'); modal.classList.remove('flex'); };
document.getElementById('sendFromPreview').onclick = doSend;
document.getElementById('orderForm').addEventListener('submit', (e)=>{ e.preventDefault(); doSend(); });
els.ctaTop.onclick = (e)=>{ e.preventDefault(); document.getElementById('orderForm').scrollIntoView({ behavior:'smooth', block:'start' }); };

/*** INIT ***/
(function init() {
  // Ø±Ù‚Ù… ÙˆØ§ØªØ³Ø§Ø¨ Ù…Ù† ?wa=
  const qs = new URLSearchParams(location.search);
  const wa = (qs.get('wa')||'').replace(/\D+/g,'');
  if(wa) WHATSAPP_NUMBER = wa;
  els.callWa.href = "https://wa.me/"+WHATSAPP_NUMBER;

  // Ù„ØºØ© + Ù†ØµÙˆØµ
  LANG = detectLang(); i18n();

  // Ø±Ù†Ø¯Ø±
  renderCarousel();
  selectedIndex = 0; selected = PRODUCTS[selectedIndex];
  renderSelected();

  // Ø£ÙˆØªÙˆ ÙƒÙØ±Ø³ÙˆÙ„
  startAutoCarousel();

  // ØµÙˆØ±Ø© About
  setAboutAuto();
})();
</script>
</body>
</html>
