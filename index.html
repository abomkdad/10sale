
  function absolutePageUrl(){
    try{
      var href=top.location.href||location.href;
      var i=href.indexOf("#"); if(i>-1) href=href.substring(0,i);
      var s=href.indexOf("?")>-1?"&":"?";
      return href+s+"v="+Date.now();
    }catch(e){ return location.href; }
  }

  function buildMsg(){
    var name=(n.value||"").trim();
    var city=(c.value||"").trim();
    var lines=[
      "["+lang.toUpperCase()+"] "+t.confirm,
      (lang==="ar"?"الاسم: ":(lang==="he"?"שם: ":"Name: "))+name,
      (lang==="ar"?"المدينة: ":(lang==="he"?"עיר: ":"City: "))+city,
      absolutePageUrl()
    ];
    return lines.join("\\n");
  }

  function apiUrl(txt){ return "https://api.whatsapp.com/send?phone="+WA_NUMBER+"&text="+encodeURIComponent(txt); }
  function waMeUrl(txt){ return "https://wa.me/"+WA_NUMBER+"?text="+encodeURIComponent(txt); }

  function update(){
    var ok=(n.value.trim()&&c.value.trim());
    if(!ok){ a.setAttribute("aria-disabled","true"); a.removeAttribute("href"); a.removeAttribute("data-fallback"); sendHeight(); return; }
    var msg=buildMsg();
    a.href=apiUrl(msg);
    a.setAttribute("data-fallback",waMeUrl(msg));
    a.setAttribute("aria-disabled","false");
    a.setAttribute("target","_top"); a.setAttribute("rel","noopener");
    sendHeight();
  }

  // ====== Auto-resize للإطار ======
  function sendHeight(){
    try{
      var h=document.documentElement.scrollHeight||document.body.scrollHeight||560;
      if(h<360) h=360;
      parent.postMessage({type:"waFormSize",height:h}, "*");
    }catch(_){}
  }
  // راقب أي تغيير بالحجم
  if(typeof ResizeObserver!=="undefined"){
    new ResizeObserver(sendHeight).observe(document.body);
  }else{
    window.addEventListener("resize", sendHeight);
    setInterval(sendHeight, 700);
  }

  n.addEventListener("input",update);
  c.addEventListener("input",update);
  update();

  a.addEventListener("click",function(e){
    if(a.getAttribute("aria-disabled")==="true"){ e.preventDefault(); return; }
    var started=Date.now(); var fb=a.getAttribute("data-fallback");
    setTimeout(function(){
      if(document.visibilityState==="visible" && Date.now()-started>850 && fb){
        top.location.href=fb;
      }
    },900);
  });
})();
</script>
</body>
</html>'></iframe>
  </div>

  <script>
    // يستقبل ارتفاع المحتوى ويضبط iframe تلقائياً
    (function(){
      var frame = document.getElementById("waFrame");
      window.addEventListener("message", function(ev){
        if(!ev || !ev.data || ev.data.type !== "waFormSize") return;
        var h = parseInt(ev.data.height, 10);
        if (!isNaN(h) && h > 200) frame.style.height = h + "px";
      });
    })();
  </script>
</body>
</html>

